pipeline {
	agent {
		kubernetes {
			inheritFrom 'default'
			defaultContainer 'dind'
		}
	}

	options {
		timeout(time: 90, unit: 'MINUTES')
		buildDiscarder(logRotator(numToKeepStr: '5'))
	}

	parameters {
		string(name: 'VERSION', defaultValue: params.VERSION ?: '', description: 'Image version', trim: true)
	}

	environment { 
		APP_NAME = 'buildpack'
		GITHUB_URL = 'https://github.com/maxmorhardt/jenkins-jobs'
		NAMESPACE = 'maxstash-apps'

		KUBECONFIG = credentials('kube-config')
	}

	stages {
		stage('Setup') {
			steps {
				script {
					checkout scmGit(
						branches: [[
							name: "$BRANCH_NAME"
						]],
						userRemoteConfigs: [[
							credentialsId: 'github',
							url: "$GITHUB_URL"
						]]
					)

					sh 'ls -lah'
					echo "Version: $VERSION"
				}
			}
		}

		stage('Validate Docker Daemon') {
			steps {
				script {
					echo "Waiting for Docker daemon to be ready..."
					def maxAttempts = 30
					def ready = false
					
					for (int i = 1; i <= maxAttempts; i++) {
						def result = sh(script: 'docker info', returnStatus: true)
						if (result == 0) {
							echo "Docker daemon is ready"
							ready = true
							break
						}

						echo "Attempt ${i}/${maxAttempts}: Docker daemon not ready yet, waiting..."
						sleep(2)
					}
					
					if (!ready) {
						error("Docker daemon failed to become ready after ${maxAttempts} attempts")
					}
				}
			}
		}

		// stage('CI') {
		// 	steps {
		// 		script {
		// 			withCredentials([usernamePassword(credentialsId: 'docker', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
		// 				sh 'echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin'
						
		// 				sh """
		// 					docker buildx build \
		// 						--platform linux/arm64/v8 \
		// 						--push \
		// 						--tag $DOCKER_USERNAME/$APP_NAME:$VERSION \
		// 						--tag $DOCKER_USERNAME/$APP_NAME:latest \
		// 						--file buildpack/Dockerfile \
		// 						.
		// 				"""
		// 			}
		// 		}
		// 	}
		// }

		stage('Validate') {
			steps {
				container('buildpack') {
					dir('buildpack') {
						script {
							echo "Deploying ${APP_NAME} for validation"

							sh """
								kubectl apply -f deployment.yaml -n ${NAMESPACE}
								kubectl rollout status deployment/${APP_NAME} -n ${NAMESPACE} --timeout=300s
							"""

							def podName = sh(
								script: "kubectl get pod -n ${NAMESPACE} -l app=${APP_NAME} -o jsonpath='{.items[0].metadata.name}'",
								returnStdout: true
							).trim()

							echo "Validating installed tools in pod: ${podName}"

							sh """
								echo "=== Go Version ==="
								kubectl exec ${podName} -n ${NAMESPACE} -- go version
								
								echo "=== Node Version ==="
								kubectl exec ${podName} -n ${NAMESPACE} -- node --version
								
								echo "=== NPM Version ==="
								kubectl exec ${podName} -n ${NAMESPACE} -- npm --version
								
								echo "=== Java Version ==="
								kubectl exec ${podName} -n ${NAMESPACE} -- java -version
								
								echo "=== Maven Version ==="
								kubectl exec ${podName} -n ${NAMESPACE} -- mvn --version
								
								echo "=== Kubectl Version ==="
								kubectl exec ${podName} -n ${NAMESPACE} -- kubectl version --client
								
								echo "=== Helm Version ==="
								kubectl exec ${podName} -n ${NAMESPACE} -- helm version
								
								echo "=== Chromium Version ==="
								kubectl exec ${podName} -n ${NAMESPACE} -- chromium --version
								
								echo "=== ChromeDriver Version ==="
								kubectl exec ${podName} -n ${NAMESPACE} -- chromium-driver --version
								
								echo "=== Git Version ==="
								kubectl exec ${podName} -n ${NAMESPACE} -- git --version
								
								echo "=== Curl Version ==="
								kubectl exec ${podName} -n ${NAMESPACE} -- curl --version
								
								echo "=== Unzip Version ==="
								kubectl exec ${podName} -n ${NAMESPACE} -- unzip -v
							"""

							echo "Validation successful, tearing down"

							sh """
								kubectl delete -f deployment.yaml -n ${NAMESPACE}
							"""

							echo "Cleanup complete"
						}
					}
				}
			}
		}
	}
}